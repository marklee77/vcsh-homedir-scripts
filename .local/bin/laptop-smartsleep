#!/bin/sh
# after this is working, have it go straight to hibernate if minutes remaining
# is less than threshold...
SLEEPLENGTH=+1minute
WAKEALARM=/sys/class/rtc/rtc0/wakealarm
rtcwake -m no -t $(date +%s -d${SLEEPLENGTH})
laptop-suspend
ALARM=$(cat ${WAKEALARM})
NOW=$(date +%s)
if [ -z ${ALARM} ] || [ ${NOW} -ge ${ALARM} ]; then
    sleep 5 # system seems to have trouble with direct suspend->hibernate
    laptop-hibernate
fi
rtcwake -m no -t ${NOW}
